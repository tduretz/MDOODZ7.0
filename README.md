# MDOODZ7.0

Welcome to MDOODZ7.0 public repository!
This version of MDOODZ is under construction, more testing will be progressively added...

![](/images/Compression_Symmetric.gif)

# Library usage

MDOODZ Source Code stored in `MDLIB` directory and compiled as a separate library with the public include header `mdoodz.h`.

In order to use it in your program, you need a setup .txt file and implemented functions `BuildInitialTopography`, `SetParticles` and `SetBCs`. 
They are passed to `RunMDOODZ` function as arguments. 

Simplified example:

```code
#include "mdoodz.h"

void BuildInitialTopography(markers *topo_chain, params model, scale scaling) {
  // topography set up routine here
}

void SetParticles(markers *particles, scale scaling, params model, mat_prop *materials) {
  // particles set up routine here
}

void SetBCs(grid *mesh, params *model, scale scaling, markers *particles, mat_prop *materials, surface *topo) {
  // Boundary conditions set up routine here
}

int main(int nargs, char *args[]) {
  char *setupFileName = GetSetupFileName(nargs, args);
  RunMDOODZ(setupFileName, BuildInitialTopography, SetParticles, SetBCs);
}
```

More examples you could find in `SETS` directory such as `ShearTemplate` or `TopoBenchCase1`.

# CMake usage

Project is ready to be built in CMake

## Prequisites and setup

In order to build MDOODZ with CMake you have to install **cmake 3.16** or newer version.
`blas`, `zlib` and `lapack`  libraries are CMake compatible and does not require any additional setup other than installing them with your package manager:

```bash
sudo apt-get install libblas-dev liblapack-dev zlib1g-dev libhdf5-serial-dev
```

There are two ways how to use SuiteSparse:

1) Build SuiteSparse to the project:

```bash
make install-suitesparse
```

2) Specify path to the build SuiteSparse on your machine in the `env.cmake` file:

```code
set(SuiteSparse_DIR /usr/lib/x86_64-linux-gnu/)
```

If there is a SuiteSparse in a `deps` folder, it will be automatically linked with the MDOODZ. 
Otherwise it will try to find library and headers in a specified path.

## How to use

You can specify C Compiler in the `env.cmake` file. By default, it's gcc:

```code
set(C_COMPILER gcc)
```

### Add your set to the CMake

1) In a `SETS` directory you need to create executable `YourSetName.c` file and the `YourSetName.txt` setup file. Both files should have a same name.
2) In `SETS/CMakeLists.txt` file add a line with the command `add_set(YourSetName)`


### Build and run

CMake gives us a framework for building MDOODZ in developer mode or as a separate package and CTest can be used as test suite.

Makefile related to cmake is located in a root directory

To build library, tests and executables with OpenMP and in optimised mode:

```bash
make build
```

To explicitly set OPT (optimisation) and OMP (OpenMP). If not stated, it's OFF by default

```bash
make build-dev OMP=ON OPT=ON
```

Build files will be located at the `cmake-build/` directory.
Executables will be stored in a `cmake-exec/YourSetName/` directory

After building, you could run MDOODZ with:
```bash
make run SET=YourSetName
```

or run autotests:
```bash
make run-tests
```

Whole process in cluster mode with optimisation and OpenMP:

```bash
make clean build run SET=YourSetName
```

All output files generated by the runtime (`.gzip.h5`, `.dat`) will be stored in a same directory as the executable.

Setup `.txt` file will be automatically detected if it has a same name as the executable. But alternatively you can specify it explicitly:

```bash
cd cmake-exec/YourSetName
./YourSetName /path/to/setup.txt
```